<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Player Projections</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9fa;
        }
        .file-input-wrapper {
            display: inline-block;
            margin: 10px;
        }
        .file-input-wrapper label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .file-input-wrapper label:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .file-input-wrapper input[type="file"] {
            display: none;
        }
        .file-name {
            display: block;
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
        }
        .projections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .projections-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        .projections-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .projections-table tr:hover {
            background: #f8f9fa;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .download-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .stats-highlight {
            font-weight: 600;
            color: #667eea;
        }
        
        /* Betstamp Section Styles */
        .betstamp-section {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 2px solid #e0e0e0;
        }
        .betstamp-paste {
            width: 100%;
            height: 200px;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .comparison-table th {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
        }
        .comparison-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }
        .comparison-table tr:hover {
            background: #f0f0f0 !important;
        }
        .edge-positive {
            background: #d4edda !important;
            color: #155724;
        }
        .edge-negative {
            background: #f8d7da !important;
            color: #721c24;
        }
        .edge-neutral {
            background: #fff3cd !important;
            color: #856404;
        }
        .player-name-cell {
            text-align: left !important;
            font-weight: 600;
        }
        .stat-type-cell {
            text-align: left !important;
        }
        .section-divider {
            margin: 40px 0;
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }
        .filter-bar {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-bar label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            background: #f0f0f0;
        }
        .filter-bar label:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÄ NBA Player Projections</h1>
            <p class="subtitle">AI-Powered Statistical Predictions</p>
        </header>

        <div class="main-content">
            <!-- Daily Projections Section -->
            <div class="input-section">
                <h2>üìä Daily Projections Generator</h2>
                <p style="color: #666; margin-bottom: 20px;">Upload NBA DFS Projections CSV to generate all player projections</p>
                
                <div class="upload-area">
                    <h3 style="margin-bottom: 20px;">Upload Minute Projections</h3>
                    
                    <div class="file-input-wrapper">
                        <label for="dfsFile">
                            üìÑ NBA DFS Projections CSV
                        </label>
                        <input type="file" id="dfsFile" accept=".csv">
                        <span class="file-name" id="dfsFileName">No file selected</span>
                    </div>

                    <br><br>
                    <button class="btn-predict" id="generateDailyBtn" style="width: auto; padding: 15px 40px;">
                        Generate All Projections
                    </button>
                </div>

                <!-- Daily Results -->
                <div id="dailyResults" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="projectionsCount">0 Projections Generated</h3>
                        <button class="download-btn" id="downloadBtn">
                            ‚¨áÔ∏è Download CSV
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div style="margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="playerSearch" 
                            placeholder="üîç Search player name..." 
                            style="width: 100%; padding: 12px 20px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                        >
                    </div>

                    <div class="table-container">
                        <table class="projections-table" id="projectionsTable">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Team</th>
                                    <th>Opp</th>
                                    <th>Pos</th>
                                    <th>Min</th>
                                    <th>PTS</th>
                                    <th>REB</th>
                                    <th>AST</th>
                                    <th>3PM</th>
                                    <th>STL</th>
                                    <th>BLK</th>
                                    <th>TO</th>
                                    <th class="stats-highlight">PRA</th>
                                </tr>
                            </thead>
                            <tbody id="projectionsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <!-- Betstamp Comparison Section -->
            <div class="betstamp-section">
                <h2>üìà Line Comparison Tool</h2>
                <p style="color: #666; margin-bottom: 20px;">Paste Betstamp data to compare FanDuel lines with your projections</p>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <label for="betstampData" style="font-weight: 600; display: block; margin-bottom: 10px;">
                        Paste Betstamp Data (copy entire table from Betstamp Props view):
                    </label>
                    <textarea 
                        id="betstampData" 
                        class="betstamp-paste"
                        placeholder="Copy and paste the entire Betstamp props table here..."></textarea>
                    <button class="btn-predict" id="parseBetstampBtn" style="width: auto; padding: 12px 30px;">
                        üîç Parse & Compare Lines
                    </button>
                </div>

                <!-- Comparison Results -->
                <div id="comparisonResults" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="comparisonCount">0 Lines Compared</h3>
                        <button class="download-btn" id="downloadEdgesBtn" style="background: #e74c3c;">
                            ‚¨áÔ∏è Download Edges
                        </button>
                    </div>

                    <div class="filter-bar">
                        <label>
                            <input type="checkbox" id="filterPositive"> 
                            <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">+EV Only</span>
                        </label>
                        <label>
                            <input type="checkbox" id="filterOver" checked> 
                            <span>Overs</span>
                        </label>
                        <label>
                            <input type="checkbox" id="filterUnder" checked> 
                            <span>Unders</span>
                        </label>
                        <label>
                            <input type="number" id="minEdge" value="0.5" step="0.1" min="0" style="width: 60px;">
                            <span>Min Edge</span>
                        </label>
                    </div>

                    <div class="table-container" style="max-height: 500px;">
                        <table class="comparison-table" id="comparisonTable">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Stat</th>
                                    <th>FD Line</th>
                                    <th>Our Proj</th>
                                    <th>Diff</th>
                                    <th>Play</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="loading" id="loadingSpinner" style="display: none;">
                <div class="spinner"></div>
                <p>Calculating projections...</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>

        <footer>
            <p>Powered by Machine Learning | ETR-Calibrated Projections</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Store projections globally for comparison
        let currentProjections = {};

        // Parse Betstamp data
        document.getElementById('parseBetstampBtn').addEventListener('click', function() {
            const rawData = document.getElementById('betstampData').value;
            if (!rawData.trim()) {
                alert('Please paste Betstamp data first');
                return;
            }

            if (Object.keys(currentProjections).length === 0) {
                alert('Please generate projections first by uploading the DFS CSV');
                return;
            }

            const lines = parseBetstampData(rawData);
            displayComparison(lines);
        });

        function parseBetstampData(rawText) {
            const lines = rawText.split('\n').map(l => l.trim()).filter(l => l);
            const props = [];
            
            // Stats to SKIP
            const skipStats = [
                '1q', '1h', '- 1q', '- 1h',
                'double+double', 'double double',
                'first basket', 'first team basket',
                'triple+double', 'triple double',
                'team total', 'odd team total'
            ];
            
            // Valid stats we can compare
            const validStats = [
                'points', 'rebounds', 'assists', 
                '3 point fg', '3 point', 'three', 'threes',
                'steals', 'blocks', 'turnovers',
                'pts+rebs+asts', 'pts+rebs', 'pts+asts', 'rebs+asts',
                'pts+rebs+ast', 'pts+reb', 'pts+ast', 'reb+ast'
            ];
            
            let i = 0;
            while (i < lines.length) {
                // Look for date pattern (MM/DD)
                if (/^\d{2}\/\d{2}$/.test(lines[i])) {
                    const date = lines[i];
                    const time = lines[i + 1] || '';
                    const team1 = lines[i + 2] || '';
                    const team2 = lines[i + 3] || '';
                    const playerName = lines[i + 4] || '';
                    const statType = lines[i + 5] || '';
                    
                    const statLower = statType.toLowerCase();
                    const playerLower = playerName.toLowerCase();
                    
                    // Skip if stat type contains any skip keywords
                    const shouldSkip = skipStats.some(skip => 
                        statLower.includes(skip) || playerLower.includes(skip)
                    );
                    
                    // Check if it's a valid stat we can compare
                    const isValidStat = validStats.some(valid => 
                        statLower.includes(valid) || statLower === valid
                    );
                    
                    // Find the end of this prop (next date or end)
                    let propEnd = lines.length;
                    for (let j = i + 6; j < lines.length; j++) {
                        if (/^\d{2}\/\d{2}$/.test(lines[j])) {
                            propEnd = j;
                            break;
                        }
                    }
                    
                    if (shouldSkip || !isValidStat) {
                        i = propEnd;
                        continue;
                    }
                    
                    // Collect all numeric values that look like lines (not odds)
                    const lineValues = [];
                    for (let j = i + 6; j < propEnd; j++) {
                        const val = lines[j];
                        // Line values are numbers NOT starting with + or -
                        if (/^\d+\.?\d*$/.test(val)) {
                            const num = parseFloat(val);
                            if (num >= 0.5 && num <= 60) {
                                lineValues.push(num);
                            }
                        }
                    }
                    
                    // FD line should be one of the later values
                    // Format: Hold (2 lines), True Line (2 lines), FD (2 lines)
                    // So FD is at index 4-5
                    let fdLine = null;
                    if (lineValues.length >= 5) {
                        fdLine = lineValues[4];
                    } else if (lineValues.length >= 3) {
                        fdLine = lineValues[2];
                    } else if (lineValues.length >= 1) {
                        fdLine = lineValues[0];
                    }
                    
                    if (playerName && statType && fdLine !== null) {
                        props.push({
                            player: playerName,
                            stat: statType,
                            line: fdLine
                        });
                    }
                    
                    i = propEnd;
                } else {
                    i++;
                }
            }
            
            console.log('Parsed', props.length, 'props from Betstamp');
            return props;
        }

        function normalizePlayerName(name) {
            // Handle common name variations
            const nameMap = {
                'shai gilgeous-alexander': 'shai gilgeous-alexander',
                'karl-anthony towns': 'karl-anthony towns',
                'og anunoby': 'og anunoby',
                'pj washington': 'p.j. washington',
                'aj green': 'a.j. green',
                'cj mccollum': 'cj mccollum',
                'tj mcconnell': 't.j. mcconnell',
                'rj barrett': 'rj barrett',
                'nickeil alexander-walker': 'nickeil alexander-walker'
            };
            
            const lower = name.toLowerCase().trim();
            return nameMap[lower] || lower;
        }

        function getProjectionForStat(playerName, statType) {
            const normalizedSearch = normalizePlayerName(playerName);
            
            // Find player in projections
            for (const [name, proj] of Object.entries(currentProjections)) {
                const normalizedProj = normalizePlayerName(name);
                
                // Check for match (partial matching for flexibility)
                const searchParts = normalizedSearch.split(' ');
                const projParts = normalizedProj.split(' ');
                
                // Match if last name matches and first initial/name matches
                const lastNameMatch = searchParts[searchParts.length - 1] === projParts[projParts.length - 1];
                const firstMatch = searchParts[0] === projParts[0] || 
                                   searchParts[0].charAt(0) === projParts[0].charAt(0);
                
                if (lastNameMatch && firstMatch) {
                    // Map stat type to projection field
                    const stat = statType.toLowerCase().trim();
                    
                    // Points
                    if (stat === 'points') return proj.points;
                    
                    // Rebounds
                    if (stat === 'rebounds') return proj.rebounds;
                    
                    // Assists
                    if (stat === 'assists') return proj.assists;
                    
                    // 3 Pointers
                    if (stat === '3 point fg' || stat === '3-pointers' || stat === 'threes' || 
                        stat.includes('3 point') || stat.includes('three')) {
                        return proj.three_pointers_made;
                    }
                    
                    // Steals
                    if (stat === 'steals' || stat.includes('steal')) return proj.steals;
                    
                    // Blocks
                    if (stat === 'blocks' || stat.includes('block')) return proj.blocks;
                    
                    // Turnovers
                    if (stat === 'turnovers' || stat.includes('turnover')) return proj.turnovers;
                    
                    // Combos - PRA
                    if (stat === 'pts+rebs+asts' || stat === 'pts+reb+ast' || 
                        stat.includes('pts+rebs+ast') || stat.includes('points+rebounds+assists')) {
                        return proj.pra;
                    }
                    
                    // Combos - PR
                    if (stat === 'pts+rebs' || stat === 'pts+reb' || 
                        stat.includes('pts+reb') || stat.includes('points+rebounds')) {
                        return proj.points + proj.rebounds;
                    }
                    
                    // Combos - PA
                    if (stat === 'pts+asts' || stat === 'pts+ast' ||
                        stat.includes('pts+ast') || stat.includes('points+assists')) {
                        return proj.points + proj.assists;
                    }
                    
                    // Combos - RA
                    if (stat === 'rebs+asts' || stat === 'reb+ast' ||
                        stat.includes('rebs+ast') || stat.includes('rebounds+assists')) {
                        return proj.rebounds + proj.assists;
                    }
                    
                    return null;
                }
            }
            return null;
        }

        function displayComparison(props) {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            
            let matchedCount = 0;
            const comparisons = [];
            
            props.forEach(prop => {
                const ourProj = getProjectionForStat(prop.player, prop.stat);
                
                if (ourProj !== null) {
                    matchedCount++;
                    const diff = ourProj - prop.line;
                    
                    // Determine play
                    let play = '';
                    let edgeClass = 'edge-neutral';
                    
                    if (diff > 0.5) {
                        play = 'OVER ‚úÖ';
                        edgeClass = 'edge-positive';
                    } else if (diff < -0.5) {
                        play = 'UNDER ‚úÖ';
                        edgeClass = 'edge-positive';
                    } else {
                        play = '-';
                        edgeClass = 'edge-neutral';
                    }
                    
                    comparisons.push({
                        player: prop.player,
                        stat: prop.stat,
                        line: prop.line,
                        proj: ourProj,
                        diff: diff,
                        play: play,
                        edgeClass: edgeClass,
                        isOver: diff > 0,
                        isUnder: diff < 0
                    });
                }
            });
            
            // Sort by absolute diff (biggest edges first)
            comparisons.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
            
            // Store for filtering
            window.allComparisons = comparisons;
            
            renderComparisons(comparisons);
            
            document.getElementById('comparisonCount').textContent = `${matchedCount} Lines Matched`;
            document.getElementById('comparisonResults').style.display = 'block';
        }

        function renderComparisons(comparisons) {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            
            comparisons.forEach(comp => {
                const row = document.createElement('tr');
                row.className = comp.edgeClass;
                row.dataset.isOver = comp.isOver;
                row.dataset.isUnder = comp.isUnder;
                row.dataset.absDiff = Math.abs(comp.diff);
                row.innerHTML = `
                    <td class="player-name-cell">${comp.player}</td>
                    <td class="stat-type-cell">${comp.stat}</td>
                    <td>${comp.line}</td>
                    <td><strong>${comp.proj.toFixed(1)}</strong></td>
                    <td>${comp.diff > 0 ? '+' : ''}${comp.diff.toFixed(2)}</td>
                    <td><strong>${comp.play}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Override fetch to capture projections
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
                const clonedResponse = response.clone();
                if (args[0] === '/generate_daily') {
                    clonedResponse.json().then(data => {
                        if (data.projections) {
                            currentProjections = {};
                            data.projections.forEach(p => {
                                currentProjections[p.player] = p;
                            });
                            console.log('Stored', Object.keys(currentProjections).length, 'projections for comparison');
                        }
                    }).catch(e => console.log('Could not parse response:', e));
                }
                return response;
            });
        };

        // Download edges as CSV
        document.getElementById('downloadEdgesBtn').addEventListener('click', function() {
            if (!window.allComparisons || window.allComparisons.length === 0) {
                alert('No comparisons to download');
                return;
            }
            
            let csv = 'Player,Stat,FD Line,Our Proj,Diff,Play\n';
            window.allComparisons.forEach(comp => {
                csv += `"${comp.player}","${comp.stat}",${comp.line},${comp.proj.toFixed(1)},${comp.diff.toFixed(2)},"${comp.play}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'line_edges.csv';
            a.click();
        });

        // Filter functionality
        document.getElementById('filterPositive').addEventListener('change', applyFilters);
        document.getElementById('filterOver').addEventListener('change', applyFilters);
        document.getElementById('filterUnder').addEventListener('change', applyFilters);
        document.getElementById('minEdge').addEventListener('change', applyFilters);

        function applyFilters() {
            const showPositiveOnly = document.getElementById('filterPositive').checked;
            const showOver = document.getElementById('filterOver').checked;
            const showUnder = document.getElementById('filterUnder').checked;
            const minEdge = parseFloat(document.getElementById('minEdge').value) || 0;
            
            const rows = document.querySelectorAll('#comparisonTableBody tr');
            rows.forEach(row => {
                const isOver = row.dataset.isOver === 'true';
                const isUnder = row.dataset.isUnder === 'true';
                const absDiff = parseFloat(row.dataset.absDiff);
                const isPositive = row.classList.contains('edge-positive');
                
                let show = true;
                
                if (showPositiveOnly && !isPositive) show = false;
                if (isOver && !showOver) show = false;
                if (isUnder && !showUnder) show = false;
                if (absDiff < minEdge) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }
    </script>
</body>
</html>
